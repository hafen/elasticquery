<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Buildin Queries • elasticquery</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Buildin Queries">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">elasticquery</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">Home</a>
</li>
<li>
  <a href="../articles/usage.html">Usage</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/hafen/elasticquery">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Buildin Queries</h1>
            
      
      
      <div class="hidden name"><code>usage.Rmd</code></div>

    </div>

    
    
<div id="setup" class="section level1">
<h1 class="hasAnchor">
<a href="#setup" class="anchor"></a>Setup</h1>
<p>The first thing to do is to establish a connection with the Elasticsearch server. In our case, it is running locally on port 9200.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(elasticquery)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1-3" data-line-number="3">con &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/es_connect.html">es_connect</a></span>(</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">  <span class="dt">host =</span> <span class="st">"127.0.0.1"</span>, <span class="dt">port =</span> <span class="dv">9200</span>,</a>
<a class="sourceLine" id="cb1-5" data-line-number="5">  <span class="dt">primary_index =</span> <span class="st">"eios-items"</span>)</a></code></pre></div>
<p>This connection object is passed to queries so it knows where to go to run the query.</p>
<p>Note that we can also specify the <code>primary_index</code>, which is the index used by default by queries we build unless we specify otherwise in the query. Here we are querying “eios-items” by default.</p>
</div>
<div id="queries" class="section level1">
<h1 class="hasAnchor">
<a href="#queries" class="anchor"></a>Queries</h1>
<p>Two major types of queries are currently supported by this package.</p>
<ol style="list-style-type: decimal">
<li>
<strong>Aggregation</strong>: Documents are counted by specified fields in the data</li>
<li>
<strong>Fetch</strong>: Documents are retrieved according to specified criteria</li>
</ol>
<div id="aggregation-queries" class="section level2">
<h2 class="hasAnchor">
<a href="#aggregation-queries" class="anchor"></a>Aggregation Queries</h2>
<p>Aggregation queries are constructed by</p>
<ul>
<li>Initiate an aggregation query using <code><a href="https://rdrr.io/pkg/elasticquery/man/query_agg.html">query_agg()</a></code>
</li>
<li>Build on this query by specifying combinations of:
<ul>
<li>Fields to aggregate on using <code><a href="https://rdrr.io/pkg/elasticquery/man/agg_by_field.html">agg_by_field()</a></code>
</li>
<li>Date binning using <code><a href="https://rdrr.io/pkg/elasticquery/man/agg_by_date.html">agg_by_date()</a></code>
</li>
</ul>
</li>
</ul>
<div id="initiating-a-query" class="section level3">
<h3 class="hasAnchor">
<a href="#initiating-a-query" class="anchor"></a>Initiating a Query</h3>
<p>To initiate an aggregation query, we use the function <code><a href="https://rdrr.io/pkg/elasticquery/man/query_agg.html">query_agg()</a></code>, and pass it our connection object.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">query &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/query_agg.html">query_agg</a></span>(con)</a></code></pre></div>
<p>We can view the query’s translation to an Elasticsearch search body string simply through printing the query.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">query</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="co">#&gt; {}</span></a></code></pre></div>
<p>Here, of course, the query is empty as we haven’t specified aggregation dimensions yet.</p>
<p>Queries can be executed using the <code><a href="https://rdrr.io/pkg/elasticquery/man/run.html">run()</a></code> function.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/run.html">run</a></span>(query)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="co">#&gt; # A tibble: 0 x 0</span></a></code></pre></div>
<p>Since the query is empty, nothing is returned.</p>
</div>
<div id="getting-a-list-of-queryable-fields" class="section level3">
<h3 class="hasAnchor">
<a href="#getting-a-list-of-queryable-fields" class="anchor"></a>Getting a List of Queryable Fields</h3>
<p>To begin specifying fields to aggregate on, it can be helpful to get a view of what fields are available to aggregate on. This can be done by passing the connection object to `queryable_fields().</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/queryable_fields.html">queryable_fields</a></span>(con)</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="co">#&gt; # A tibble: 37 x 2</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="co">#&gt;    field                type   </span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="co">#&gt;    &lt;chr&gt;                &lt;chr&gt;  </span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="co">#&gt;  1 affectedCountries    keyword</span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6"><span class="co">#&gt;  2 affectedCountriesIso keyword</span></a>
<a class="sourceLine" id="cb5-7" data-line-number="7"><span class="co">#&gt;  3 childIds             keyword</span></a>
<a class="sourceLine" id="cb5-8" data-line-number="8"><span class="co">#&gt;  4 continentCodes       keyword</span></a>
<a class="sourceLine" id="cb5-9" data-line-number="9"><span class="co">#&gt;  5 description          text   </span></a>
<a class="sourceLine" id="cb5-10" data-line-number="10"><span class="co">#&gt;  6 duplicateId          keyword</span></a>
<a class="sourceLine" id="cb5-11" data-line-number="11"><span class="co">#&gt;  7 entityType           keyword</span></a>
<a class="sourceLine" id="cb5-12" data-line-number="12"><span class="co">#&gt;  8 flaggedByUserIds     integer</span></a>
<a class="sourceLine" id="cb5-13" data-line-number="13"><span class="co">#&gt;  9 fullText             text   </span></a>
<a class="sourceLine" id="cb5-14" data-line-number="14"><span class="co">#&gt; 10 id                   integer</span></a>
<a class="sourceLine" id="cb5-15" data-line-number="15"><span class="co">#&gt; # … with 27 more rows</span></a></code></pre></div>
</div>
<div id="aggregating-by-fields" class="section level3">
<h3 class="hasAnchor">
<a href="#aggregating-by-fields" class="anchor"></a>Aggregating by Fields</h3>
<p>Suppose we want to tabulate the frequency of all of the fields in the index. We can do this by adding <code><a href="https://rdrr.io/pkg/elasticquery/man/agg_by_field.html">agg_by_field()</a></code> to our query, specifying the field name “tags”.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">query &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/query_agg.html">query_agg</a></span>(con) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/agg_by_field.html">agg_by_field</a></span>(<span class="st">"tags"</span>)</a></code></pre></div>
<p>The function <code><a href="https://rdrr.io/pkg/elasticquery/man/agg_by_field.html">agg_by_field()</a></code>, and all subsequent query modifying functions take a query object as its input and emit a modified query object as its output. This makes these functions suitable for piping, which is a convenient and expressive way to build queries.</p>
<p>To see what this new query looks like:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">query</a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="co">#&gt; {</span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="co">#&gt;   "size": 0,</span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="co">#&gt;   "aggs": {</span></a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="co">#&gt;     "agg_results": {</span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="co">#&gt;       "composite": {</span></a>
<a class="sourceLine" id="cb7-7" data-line-number="7"><span class="co">#&gt;         "size": 1000,</span></a>
<a class="sourceLine" id="cb7-8" data-line-number="8"><span class="co">#&gt;         "sources": [</span></a>
<a class="sourceLine" id="cb7-9" data-line-number="9"><span class="co">#&gt;           {</span></a>
<a class="sourceLine" id="cb7-10" data-line-number="10"><span class="co">#&gt;             "tags": {</span></a>
<a class="sourceLine" id="cb7-11" data-line-number="11"><span class="co">#&gt;               "terms": {</span></a>
<a class="sourceLine" id="cb7-12" data-line-number="12"><span class="co">#&gt;                 "field": "tags"</span></a>
<a class="sourceLine" id="cb7-13" data-line-number="13"><span class="co">#&gt;               }</span></a>
<a class="sourceLine" id="cb7-14" data-line-number="14"><span class="co">#&gt;             }</span></a>
<a class="sourceLine" id="cb7-15" data-line-number="15"><span class="co">#&gt;           }</span></a>
<a class="sourceLine" id="cb7-16" data-line-number="16"><span class="co">#&gt;         ]</span></a>
<a class="sourceLine" id="cb7-17" data-line-number="17"><span class="co">#&gt;       }</span></a>
<a class="sourceLine" id="cb7-18" data-line-number="18"><span class="co">#&gt;     }</span></a>
<a class="sourceLine" id="cb7-19" data-line-number="19"><span class="co">#&gt;   }</span></a>
<a class="sourceLine" id="cb7-20" data-line-number="20"><span class="co">#&gt; }</span></a></code></pre></div>
<p><strong>Note</strong> that aggregation queries use <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-composite-aggregation.html">composite aggregation</a> with paging, and running the query will automatically take care of recurrent queries until paging is done and bind the results together, saving a lot of tedious work.</p>
<p>We can retrieve the result of this query by calling <code><a href="https://rdrr.io/pkg/elasticquery/man/run.html">run()</a></code>.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/run.html">run</a></span>(query)</a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="co">#&gt; # A tibble: 289 x 2</span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="co">#&gt;    tags                                 count</span></a>
<a class="sourceLine" id="cb8-4" data-line-number="4"><span class="co">#&gt;    &lt;chr&gt;                                &lt;int&gt;</span></a>
<a class="sourceLine" id="cb8-5" data-line-number="5"><span class="co">#&gt;  1 f:10:All MSF Categories               2433</span></a>
<a class="sourceLine" id="cb8-6" data-line-number="6"><span class="co">#&gt;  2 f:10:Biological                         70</span></a>
<a class="sourceLine" id="cb8-7" data-line-number="7"><span class="co">#&gt;  3 f:10:CWA                                 3</span></a>
<a class="sourceLine" id="cb8-8" data-line-number="8"><span class="co">#&gt;  4 f:10:Chemical                          349</span></a>
<a class="sourceLine" id="cb8-9" data-line-number="9"><span class="co">#&gt;  5 f:10:EXPO                                3</span></a>
<a class="sourceLine" id="cb8-10" data-line-number="10"><span class="co">#&gt;  6 f:10:HPV_grouped                        27</span></a>
<a class="sourceLine" id="cb8-11" data-line-number="11"><span class="co">#&gt;  7 f:10:HPV_notgrouped                    322</span></a>
<a class="sourceLine" id="cb8-12" data-line-number="12"><span class="co">#&gt;  8 f:10:Nuclear                            39</span></a>
<a class="sourceLine" id="cb8-13" data-line-number="13"><span class="co">#&gt;  9 f:10:zAll Hazards Threats (optional)  1974</span></a>
<a class="sourceLine" id="cb8-14" data-line-number="14"><span class="co">#&gt; 10 f:11:All UNICEF Categories            2433</span></a>
<a class="sourceLine" id="cb8-15" data-line-number="15"><span class="co">#&gt; # … with 279 more rows</span></a></code></pre></div>
<p>We can continue to add more dimensions to the aggregation using pipes. For example, to count the frequency of both the fields “tags” and “affectedCountriesIso”:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/query_agg.html">query_agg</a></span>(con) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/agg_by_field.html">agg_by_field</a></span>(<span class="st">"tags"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/agg_by_field.html">agg_by_field</a></span>(<span class="st">"affectedCountriesIso"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/run.html">run</a></span>()</a>
<a class="sourceLine" id="cb9-5" data-line-number="5"><span class="co">#&gt; # A tibble: 9,338 x 3</span></a>
<a class="sourceLine" id="cb9-6" data-line-number="6"><span class="co">#&gt;    tags                    affectedCountriesIso count</span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7"><span class="co">#&gt;    &lt;chr&gt;                   &lt;chr&gt;                &lt;int&gt;</span></a>
<a class="sourceLine" id="cb9-8" data-line-number="8"><span class="co">#&gt;  1 f:10:All MSF Categories AD                       2</span></a>
<a class="sourceLine" id="cb9-9" data-line-number="9"><span class="co">#&gt;  2 f:10:All MSF Categories AE                      10</span></a>
<a class="sourceLine" id="cb9-10" data-line-number="10"><span class="co">#&gt;  3 f:10:All MSF Categories AF                      20</span></a>
<a class="sourceLine" id="cb9-11" data-line-number="11"><span class="co">#&gt;  4 f:10:All MSF Categories AG                       1</span></a>
<a class="sourceLine" id="cb9-12" data-line-number="12"><span class="co">#&gt;  5 f:10:All MSF Categories AL                      12</span></a>
<a class="sourceLine" id="cb9-13" data-line-number="13"><span class="co">#&gt;  6 f:10:All MSF Categories AM                       3</span></a>
<a class="sourceLine" id="cb9-14" data-line-number="14"><span class="co">#&gt;  7 f:10:All MSF Categories AO                       7</span></a>
<a class="sourceLine" id="cb9-15" data-line-number="15"><span class="co">#&gt;  8 f:10:All MSF Categories AR                      46</span></a>
<a class="sourceLine" id="cb9-16" data-line-number="16"><span class="co">#&gt;  9 f:10:All MSF Categories AT                      50</span></a>
<a class="sourceLine" id="cb9-17" data-line-number="17"><span class="co">#&gt; 10 f:10:All MSF Categories AU                      94</span></a>
<a class="sourceLine" id="cb9-18" data-line-number="18"><span class="co">#&gt; # … with 9,328 more rows</span></a></code></pre></div>
</div>
<div id="aggregating-by-date-binning" class="section level3">
<h3 class="hasAnchor">
<a href="#aggregating-by-date-binning" class="anchor"></a>Aggregating by Date Binning</h3>
<p>Suppose we want to get daily counts for each tag in the data. We can use a function <code><a href="https://rdrr.io/pkg/elasticquery/man/agg_by_date.html">agg_by_date()</a></code>, which by default aggregates daily.</p>
<p>Here, we aggregate on a document’s field “processedOnDate”.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/query_agg.html">query_agg</a></span>(con) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/agg_by_field.html">agg_by_field</a></span>(<span class="st">"tags"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/agg_by_date.html">agg_by_date</a></span>(<span class="st">"processedOnDate"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/run.html">run</a></span>()</a>
<a class="sourceLine" id="cb10-5" data-line-number="5"><span class="co">#&gt; # A tibble: 11,413 x 3</span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6"><span class="co">#&gt;    tags                    processedOnDate     count</span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7"><span class="co">#&gt;    &lt;chr&gt;                   &lt;dttm&gt;              &lt;int&gt;</span></a>
<a class="sourceLine" id="cb10-8" data-line-number="8"><span class="co">#&gt;  1 f:10:All MSF Categories 2012-01-31 00:00:00     1</span></a>
<a class="sourceLine" id="cb10-9" data-line-number="9"><span class="co">#&gt;  2 f:10:All MSF Categories 2012-02-02 00:00:00     1</span></a>
<a class="sourceLine" id="cb10-10" data-line-number="10"><span class="co">#&gt;  3 f:10:All MSF Categories 2012-02-03 00:00:00     1</span></a>
<a class="sourceLine" id="cb10-11" data-line-number="11"><span class="co">#&gt;  4 f:10:All MSF Categories 2012-02-08 00:00:00     2</span></a>
<a class="sourceLine" id="cb10-12" data-line-number="12"><span class="co">#&gt;  5 f:10:All MSF Categories 2012-02-10 00:00:00     2</span></a>
<a class="sourceLine" id="cb10-13" data-line-number="13"><span class="co">#&gt;  6 f:10:All MSF Categories 2012-02-13 00:00:00     1</span></a>
<a class="sourceLine" id="cb10-14" data-line-number="14"><span class="co">#&gt;  7 f:10:All MSF Categories 2012-02-14 00:00:00     1</span></a>
<a class="sourceLine" id="cb10-15" data-line-number="15"><span class="co">#&gt;  8 f:10:All MSF Categories 2012-02-16 00:00:00     1</span></a>
<a class="sourceLine" id="cb10-16" data-line-number="16"><span class="co">#&gt;  9 f:10:All MSF Categories 2012-02-18 00:00:00     1</span></a>
<a class="sourceLine" id="cb10-17" data-line-number="17"><span class="co">#&gt; 10 f:10:All MSF Categories 2012-02-20 00:00:00     2</span></a>
<a class="sourceLine" id="cb10-18" data-line-number="18"><span class="co">#&gt; # … with 11,403 more rows</span></a></code></pre></div>
<p>For finer control over the date binning, we can use functions <code><a href="https://rdrr.io/pkg/elasticquery/man/calendar_interval.html">calendar_interval()</a></code> and <code><a href="https://rdrr.io/pkg/elasticquery/man/fixed_interval.html">fixed_interval()</a></code>.</p>
<p>For example, to bin on calendar week:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/query_agg.html">query_agg</a></span>(con) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/agg_by_field.html">agg_by_field</a></span>(<span class="st">"tags"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb11-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/agg_by_date.html">agg_by_date</a></span>(<span class="st">"processedOnDate"</span>, <span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/calendar_interval.html">calendar_interval</a></span>(<span class="st">"1w"</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb11-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/run.html">run</a></span>()</a>
<a class="sourceLine" id="cb11-5" data-line-number="5"><span class="co">#&gt; # A tibble: 4,543 x 3</span></a>
<a class="sourceLine" id="cb11-6" data-line-number="6"><span class="co">#&gt;    tags                    processedOnDate     count</span></a>
<a class="sourceLine" id="cb11-7" data-line-number="7"><span class="co">#&gt;    &lt;chr&gt;                   &lt;dttm&gt;              &lt;int&gt;</span></a>
<a class="sourceLine" id="cb11-8" data-line-number="8"><span class="co">#&gt;  1 f:10:All MSF Categories 2012-01-30 00:00:00     3</span></a>
<a class="sourceLine" id="cb11-9" data-line-number="9"><span class="co">#&gt;  2 f:10:All MSF Categories 2012-02-06 00:00:00     4</span></a>
<a class="sourceLine" id="cb11-10" data-line-number="10"><span class="co">#&gt;  3 f:10:All MSF Categories 2012-02-13 00:00:00     4</span></a>
<a class="sourceLine" id="cb11-11" data-line-number="11"><span class="co">#&gt;  4 f:10:All MSF Categories 2012-02-20 00:00:00     4</span></a>
<a class="sourceLine" id="cb11-12" data-line-number="12"><span class="co">#&gt;  5 f:10:All MSF Categories 2012-04-09 00:00:00     1</span></a>
<a class="sourceLine" id="cb11-13" data-line-number="13"><span class="co">#&gt;  6 f:10:All MSF Categories 2012-04-16 00:00:00     2</span></a>
<a class="sourceLine" id="cb11-14" data-line-number="14"><span class="co">#&gt;  7 f:10:All MSF Categories 2012-04-23 00:00:00     2</span></a>
<a class="sourceLine" id="cb11-15" data-line-number="15"><span class="co">#&gt;  8 f:10:All MSF Categories 2012-04-30 00:00:00     6</span></a>
<a class="sourceLine" id="cb11-16" data-line-number="16"><span class="co">#&gt;  9 f:10:All MSF Categories 2012-05-07 00:00:00     1</span></a>
<a class="sourceLine" id="cb11-17" data-line-number="17"><span class="co">#&gt; 10 f:10:All MSF Categories 2012-05-14 00:00:00     2</span></a>
<a class="sourceLine" id="cb11-18" data-line-number="18"><span class="co">#&gt; # … with 4,533 more rows</span></a></code></pre></div>
<p>And to bin on every 10 days:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/query_agg.html">query_agg</a></span>(con) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/agg_by_field.html">agg_by_field</a></span>(<span class="st">"tags"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/agg_by_date.html">agg_by_date</a></span>(<span class="st">"processedOnDate"</span>, <span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/fixed_interval.html">fixed_interval</a></span>(<span class="st">"10d"</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/run.html">run</a></span>()</a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="co">#&gt; # A tibble: 3,935 x 3</span></a>
<a class="sourceLine" id="cb12-6" data-line-number="6"><span class="co">#&gt;    tags                    processedOnDate     count</span></a>
<a class="sourceLine" id="cb12-7" data-line-number="7"><span class="co">#&gt;    &lt;chr&gt;                   &lt;dttm&gt;              &lt;int&gt;</span></a>
<a class="sourceLine" id="cb12-8" data-line-number="8"><span class="co">#&gt;  1 f:10:All MSF Categories 2012-01-31 00:00:00     5</span></a>
<a class="sourceLine" id="cb12-9" data-line-number="9"><span class="co">#&gt;  2 f:10:All MSF Categories 2012-02-10 00:00:00     6</span></a>
<a class="sourceLine" id="cb12-10" data-line-number="10"><span class="co">#&gt;  3 f:10:All MSF Categories 2012-02-20 00:00:00     4</span></a>
<a class="sourceLine" id="cb12-11" data-line-number="11"><span class="co">#&gt;  4 f:10:All MSF Categories 2012-04-10 00:00:00     2</span></a>
<a class="sourceLine" id="cb12-12" data-line-number="12"><span class="co">#&gt;  5 f:10:All MSF Categories 2012-04-20 00:00:00     3</span></a>
<a class="sourceLine" id="cb12-13" data-line-number="13"><span class="co">#&gt;  6 f:10:All MSF Categories 2012-04-30 00:00:00     6</span></a>
<a class="sourceLine" id="cb12-14" data-line-number="14"><span class="co">#&gt;  7 f:10:All MSF Categories 2012-05-10 00:00:00     3</span></a>
<a class="sourceLine" id="cb12-15" data-line-number="15"><span class="co">#&gt;  8 f:10:All MSF Categories 2012-05-20 00:00:00     2</span></a>
<a class="sourceLine" id="cb12-16" data-line-number="16"><span class="co">#&gt;  9 f:10:All MSF Categories 2012-05-30 00:00:00     2</span></a>
<a class="sourceLine" id="cb12-17" data-line-number="17"><span class="co">#&gt; 10 f:10:All MSF Categories 2012-06-19 00:00:00     1</span></a>
<a class="sourceLine" id="cb12-18" data-line-number="18"><span class="co">#&gt; # … with 3,925 more rows</span></a></code></pre></div>
</div>
<div id="filtering" class="section level3">
<h3 class="hasAnchor">
<a href="#filtering" class="anchor"></a>Filtering</h3>
<p>We can further modify an aggregation query by specifying filters. Three types of filters are currently available:</p>
<ul>
<li>Range filters: specify a range of values a field can have</li>
<li>Terms filters: specify a value or vector of values a field must take</li>
<li>Match filters: match a specified string in a field</li>
</ul>
<p><strong>Note</strong> that filters can apply to both aggregation and fetch queries.</p>
<div id="range-filters" class="section level4">
<h4 class="hasAnchor">
<a href="#range-filters" class="anchor"></a>Range Filters</h4>
<p>Range filters are specifyind using <code><a href="https://rdrr.io/pkg/elasticquery/man/filter_range.html">filter_range()</a></code>, specifying the field to filter, and then specifying one or both of <code>from</code> and <code>to</code> values for the range.</p>
<p>For example, to take our earlier aggregation query and filter it to dates later than 2018-01-01:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/query_agg.html">query_agg</a></span>(con) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/agg_by_field.html">agg_by_field</a></span>(<span class="st">"tags"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/agg_by_date.html">agg_by_date</a></span>(<span class="st">"processedOnDate"</span>, <span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/calendar_interval.html">calendar_interval</a></span>(<span class="st">"1w"</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/filter_range.html">filter_range</a></span>(<span class="st">"processedOnDate"</span>, <span class="dt">from =</span> <span class="st">"2018-01-01"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-5" data-line-number="5"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/run.html">run</a></span>()</a>
<a class="sourceLine" id="cb13-6" data-line-number="6"><span class="co">#&gt; # A tibble: 602 x 3</span></a>
<a class="sourceLine" id="cb13-7" data-line-number="7"><span class="co">#&gt;    tags   processedOnDate     count</span></a>
<a class="sourceLine" id="cb13-8" data-line-number="8"><span class="co">#&gt;    &lt;chr&gt;  &lt;dttm&gt;              &lt;int&gt;</span></a>
<a class="sourceLine" id="cb13-9" data-line-number="9"><span class="co">#&gt;  1 l:AFRO 2018-06-18 00:00:00    17</span></a>
<a class="sourceLine" id="cb13-10" data-line-number="10"><span class="co">#&gt;  2 l:AFRO 2018-06-25 00:00:00    76</span></a>
<a class="sourceLine" id="cb13-11" data-line-number="11"><span class="co">#&gt;  3 l:AFRO 2018-07-02 00:00:00    96</span></a>
<a class="sourceLine" id="cb13-12" data-line-number="12"><span class="co">#&gt;  4 l:AFRO 2018-07-09 00:00:00     4</span></a>
<a class="sourceLine" id="cb13-13" data-line-number="13"><span class="co">#&gt;  5 l:AFRO 2018-07-23 00:00:00    44</span></a>
<a class="sourceLine" id="cb13-14" data-line-number="14"><span class="co">#&gt;  6 l:AFRO 2018-07-30 00:00:00    13</span></a>
<a class="sourceLine" id="cb13-15" data-line-number="15"><span class="co">#&gt;  7 l:AFRO 2018-09-10 00:00:00    17</span></a>
<a class="sourceLine" id="cb13-16" data-line-number="16"><span class="co">#&gt;  8 l:AFRO 2018-10-08 00:00:00    32</span></a>
<a class="sourceLine" id="cb13-17" data-line-number="17"><span class="co">#&gt;  9 l:AFRO 2018-10-22 00:00:00    40</span></a>
<a class="sourceLine" id="cb13-18" data-line-number="18"><span class="co">#&gt; 10 l:AFRO 2018-10-29 00:00:00    90</span></a>
<a class="sourceLine" id="cb13-19" data-line-number="19"><span class="co">#&gt; # … with 592 more rows</span></a></code></pre></div>
</div>
<div id="terms-filters" class="section level4">
<h4 class="hasAnchor">
<a href="#terms-filters" class="anchor"></a>Terms Filters</h4>
<p>The funtion <code><a href="https://rdrr.io/pkg/elasticquery/man/filter_terms.html">filter_terms()</a></code> adds a filter to a query that specifies certain values a field must have to be included in the aggregation.</p>
<p>For example, to add to our earlier query, suppose we require that “affectedCountriesIso” must contain “US” or “CA”:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/query_agg.html">query_agg</a></span>(con) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/agg_by_field.html">agg_by_field</a></span>(<span class="st">"tags"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/agg_by_date.html">agg_by_date</a></span>(<span class="st">"processedOnDate"</span>, <span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/calendar_interval.html">calendar_interval</a></span>(<span class="st">"1w"</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/filter_range.html">filter_range</a></span>(<span class="st">"processedOnDate"</span>, <span class="dt">from =</span> <span class="st">"2018-01-01"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-5" data-line-number="5"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/filter_terms.html">filter_terms</a></span>(<span class="st">"affectedCountriesIso"</span>, <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"US"</span>, <span class="st">"CA"</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-6" data-line-number="6"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/run.html">run</a></span>()</a>
<a class="sourceLine" id="cb14-7" data-line-number="7"><span class="co">#&gt; # A tibble: 370 x 3</span></a>
<a class="sourceLine" id="cb14-8" data-line-number="8"><span class="co">#&gt;    tags   processedOnDate     count</span></a>
<a class="sourceLine" id="cb14-9" data-line-number="9"><span class="co">#&gt;    &lt;chr&gt;  &lt;dttm&gt;              &lt;int&gt;</span></a>
<a class="sourceLine" id="cb14-10" data-line-number="10"><span class="co">#&gt;  1 l:AFRO 2018-06-18 00:00:00     3</span></a>
<a class="sourceLine" id="cb14-11" data-line-number="11"><span class="co">#&gt;  2 l:AFRO 2018-06-25 00:00:00    14</span></a>
<a class="sourceLine" id="cb14-12" data-line-number="12"><span class="co">#&gt;  3 l:AFRO 2018-07-02 00:00:00    14</span></a>
<a class="sourceLine" id="cb14-13" data-line-number="13"><span class="co">#&gt;  4 l:AFRO 2018-07-23 00:00:00    13</span></a>
<a class="sourceLine" id="cb14-14" data-line-number="14"><span class="co">#&gt;  5 l:AFRO 2018-09-10 00:00:00     5</span></a>
<a class="sourceLine" id="cb14-15" data-line-number="15"><span class="co">#&gt;  6 l:AFRO 2018-10-08 00:00:00     9</span></a>
<a class="sourceLine" id="cb14-16" data-line-number="16"><span class="co">#&gt;  7 l:AFRO 2018-10-22 00:00:00     8</span></a>
<a class="sourceLine" id="cb14-17" data-line-number="17"><span class="co">#&gt;  8 l:AFRO 2018-10-29 00:00:00    17</span></a>
<a class="sourceLine" id="cb14-18" data-line-number="18"><span class="co">#&gt;  9 l:AFRO 2018-11-05 00:00:00     8</span></a>
<a class="sourceLine" id="cb14-19" data-line-number="19"><span class="co">#&gt; 10 l:AFRO 2018-11-12 00:00:00     3</span></a>
<a class="sourceLine" id="cb14-20" data-line-number="20"><span class="co">#&gt; # … with 360 more rows</span></a></code></pre></div>
</div>
<div id="match-filters" class="section level4">
<h4 class="hasAnchor">
<a href="#match-filters" class="anchor"></a>Match Filters</h4>
<p>The function <code><a href="https://rdrr.io/pkg/elasticquery/man/filter_match.html">filter_match()</a></code> specifies a filter to only include documents where the specified field contains a match for the provided string.</p>
<p>For example, to further refine our aggregation to only include documents where a match for the string “disease” is found in the full text:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/query_agg.html">query_agg</a></span>(con) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/agg_by_field.html">agg_by_field</a></span>(<span class="st">"tags"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb15-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/agg_by_date.html">agg_by_date</a></span>(<span class="st">"processedOnDate"</span>, <span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/calendar_interval.html">calendar_interval</a></span>(<span class="st">"1w"</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb15-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/filter_range.html">filter_range</a></span>(<span class="st">"processedOnDate"</span>, <span class="dt">from =</span> <span class="st">"2018-01-01"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb15-5" data-line-number="5"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/filter_terms.html">filter_terms</a></span>(<span class="st">"affectedCountriesIso"</span>, <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"US"</span>, <span class="st">"CA"</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb15-6" data-line-number="6"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/filter_match.html">filter_match</a></span>(<span class="st">"fullText"</span>, <span class="st">"disease"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb15-7" data-line-number="7"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/run.html">run</a></span>()</a>
<a class="sourceLine" id="cb15-8" data-line-number="8"><span class="co">#&gt; # A tibble: 60 x 3</span></a>
<a class="sourceLine" id="cb15-9" data-line-number="9"><span class="co">#&gt;    tags            processedOnDate     count</span></a>
<a class="sourceLine" id="cb15-10" data-line-number="10"><span class="co">#&gt;    &lt;chr&gt;           &lt;dttm&gt;              &lt;int&gt;</span></a>
<a class="sourceLine" id="cb15-11" data-line-number="11"><span class="co">#&gt;  1 l:AFRO          2018-07-23 00:00:00     1</span></a>
<a class="sourceLine" id="cb15-12" data-line-number="12"><span class="co">#&gt;  2 l:AFRO          2018-10-29 00:00:00     1</span></a>
<a class="sourceLine" id="cb15-13" data-line-number="13"><span class="co">#&gt;  3 l:Antioxidants  2018-07-02 00:00:00     3</span></a>
<a class="sourceLine" id="cb15-14" data-line-number="14"><span class="co">#&gt;  4 l:Calcium       2018-10-29 00:00:00     2</span></a>
<a class="sourceLine" id="cb15-15" data-line-number="15"><span class="co">#&gt;  5 l:Contamination 2018-07-02 00:00:00     3</span></a>
<a class="sourceLine" id="cb15-16" data-line-number="16"><span class="co">#&gt;  6 l:Contamination 2018-09-03 00:00:00     1</span></a>
<a class="sourceLine" id="cb15-17" data-line-number="17"><span class="co">#&gt;  7 l:Contamination 2018-10-29 00:00:00     2</span></a>
<a class="sourceLine" id="cb15-18" data-line-number="18"><span class="co">#&gt;  8 l:Contamination 2018-11-05 00:00:00     1</span></a>
<a class="sourceLine" id="cb15-19" data-line-number="19"><span class="co">#&gt;  9 l:EMRO          2018-10-29 00:00:00     1</span></a>
<a class="sourceLine" id="cb15-20" data-line-number="20"><span class="co">#&gt; 10 l:EURO          2018-07-23 00:00:00     1</span></a>
<a class="sourceLine" id="cb15-21" data-line-number="21"><span class="co">#&gt; # … with 50 more rows</span></a></code></pre></div>
</div>
</div>
</div>
<div id="fetch-queries" class="section level2">
<h2 class="hasAnchor">
<a href="#fetch-queries" class="anchor"></a>Fetch Queries</h2>
<p>Fetch queries simply retrieve documents based on filtering criteria. All of the filtering functions specified above apply to these queries.</p>
<div id="initiating-a-query-1" class="section level3">
<h3 class="hasAnchor">
<a href="#initiating-a-query-1" class="anchor"></a>Initiating a Query</h3>
<p>Similar to aggregation queries, a fetch query is initialized using <code><a href="https://rdrr.io/pkg/elasticquery/man/query_fetch.html">query_fetch()</a></code>, which takes as its primary argument the connection object.</p>
<p>One optional argument of note to this function is <code>path</code>, which specifies a directory to write docuents to as they are fetched. If this is not specified, results will be read into memory. If the result set looks like it will be very large, a warning is provided that encourages the user to provide a <code>path</code> and write to disk.</p>
<p>If we intialize a fetch query with no refinements, it will returl all documents in the index.</p>
<p>For example, with our example index which contains 10k documents:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1">docs &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/query_fetch.html">query_fetch</a></span>(con) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/run.html">run</a></span>()</a></code></pre></div>
<p>This will fetch all 10k documents and return them as a large list to <code>docs</code>.</p>
<p><strong>Note</strong> that fetch queries automatically take care of <a href="https://www.elastic.co/guide/en/elasticsearch/client/javascript-api/current/scroll_examples.html">scrolling</a> to retrieve potentially very large sets of documents. The scroll limit is 10k documents, so iterative queries are run to fetch these in batches and piece them together upon retrieval.</p>
</div>
<div id="adding-filters-to-fetch-queries" class="section level3">
<h3 class="hasAnchor">
<a href="#adding-filters-to-fetch-queries" class="anchor"></a>Adding Filters to Fetch Queries</h3>
<p>It is probably more desirable for a fetch query to pinpoint records of interest rather than retrieve all documents. This can be done using filter queries as we specified earlier.</p>
<p>For example, to fetch all documents matching the filtering criteria we specified in the final aggregation example:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1">docs &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/query_fetch.html">query_fetch</a></span>(con) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/filter_range.html">filter_range</a></span>(<span class="st">"processedOnDate"</span>, <span class="dt">from =</span> <span class="st">"2018-01-01"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/filter_terms.html">filter_terms</a></span>(<span class="st">"affectedCountriesIso"</span>, <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"US"</span>, <span class="st">"CA"</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/filter_match.html">filter_match</a></span>(<span class="st">"fullText"</span>, <span class="st">"disease"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-5" data-line-number="5"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/run.html">run</a></span>()</a>
<a class="sourceLine" id="cb17-6" data-line-number="6"><span class="co">#&gt; Fetching 14 total documents...</span></a>
<a class="sourceLine" id="cb17-7" data-line-number="7"><span class="co">#&gt; 14 documents fetched (100%)...</span></a></code></pre></div>
</div>
<div id="fetching-to-disk" class="section level3">
<h3 class="hasAnchor">
<a href="#fetching-to-disk" class="anchor"></a>Fetching to Disk</h3>
<p>In the previous fetch examples, the return object <code>docs</code> has been a list format of the document content of the query.</p>
<p>In a many cases we may wish to do a bulk download of many articles. If we specify a <code>path</code> argument to <code><a href="https://rdrr.io/pkg/elasticquery/man/query_fetch.html">query_fetch()</a></code>, the results will be written in batches to the specified directory.</p>
<p>For example, to write our last query to disk, we specify a directory in our query initizilaztion. Also, note that to simulate scrolling, we specify each iteration of the query to retrieve 10 documents (instead of the default 10k documents). With this, we see that two files get written, one for each scroll.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1">tf &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span>()</a>
<a class="sourceLine" id="cb18-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span>(tf)</a>
<a class="sourceLine" id="cb18-3" data-line-number="3">docs &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/query_fetch.html">query_fetch</a></span>(con, <span class="dt">path =</span> tf, <span class="dt">size =</span> <span class="dv">10</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/filter_range.html">filter_range</a></span>(<span class="st">"processedOnDate"</span>, <span class="dt">from =</span> <span class="st">"2018-01-01"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-5" data-line-number="5"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/filter_terms.html">filter_terms</a></span>(<span class="st">"affectedCountriesIso"</span>, <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"US"</span>, <span class="st">"CA"</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-6" data-line-number="6"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/filter_match.html">filter_match</a></span>(<span class="st">"fullText"</span>, <span class="st">"disease"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-7" data-line-number="7"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/pkg/elasticquery/man/run.html">run</a></span>()</a>
<a class="sourceLine" id="cb18-8" data-line-number="8"><span class="co">#&gt; Fetching 14 total documents...</span></a>
<a class="sourceLine" id="cb18-9" data-line-number="9"><span class="co">#&gt; 10 documents fetched (71%)...</span></a>
<a class="sourceLine" id="cb18-10" data-line-number="10"><span class="co">#&gt; 14 documents fetched (100%)...</span></a>
<a class="sourceLine" id="cb18-11" data-line-number="11"></a>
<a class="sourceLine" id="cb18-12" data-line-number="12"><span class="kw"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span>(docs)</a>
<a class="sourceLine" id="cb18-13" data-line-number="13"><span class="co">#&gt; [1] "out0001.json" "out0002.json"</span></a></code></pre></div>
</div>
</div>
</div>
<div id="limitations" class="section level1">
<h1 class="hasAnchor">
<a href="#limitations" class="anchor"></a>Limitations</h1>
<p>This package is experimental and has not undergone rigorous testing to verify the correctness of the constructed queries. Use at your own risk.</p>
<p>The package has been written to cover a large number of immediate use cases. However, there are many additional feature and parameters of Elasticsearch that could be exposed through this interface.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#setup">Setup</a></li>
      <li>
<a href="#queries">Queries</a><ul class="nav nav-pills nav-stacked">
<li><a href="#aggregation-queries">Aggregation Queries</a></li>
      <li><a href="#fetch-queries">Fetch Queries</a></li>
      </ul>
</li>
      <li><a href="#limitations">Limitations</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Ryan Hafen.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
