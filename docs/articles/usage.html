<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Building Queries • elasticquery</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Building Queries">
<meta property="og:description" content="elasticquery">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">elasticquery</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">Home</a>
</li>
<li>
  <a href="../articles/usage.html">Usage</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/hafen/elasticquery">
    <span class="fas fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Building Queries</h1>
            
      
      
      <div class="hidden name"><code>usage.Rmd</code></div>

    </div>

    
    
<div id="setup" class="section level1">
<h1 class="hasAnchor">
<a href="#setup" class="anchor"></a>Setup</h1>
<p>The first thing to do is to establish a connection with the Elasticsearch server. In our case, it is running locally on port 9200.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">elasticquery</span><span class="op">)</span>

<span class="va">con</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/es_connect.html">es_connect</a></span><span class="op">(</span>
  host <span class="op">=</span> <span class="st">"127.0.0.1"</span>, port <span class="op">=</span> <span class="fl">9200</span>,
  primary_index <span class="op">=</span> <span class="st">"my-index"</span><span class="op">)</span></code></pre></div>
<p>This connection object is passed to queries so it knows where to go to run the query.</p>
<p>Note that we can also specify the <code>primary_index</code>, which is the index used by default by queries we build unless we specify otherwise in the query. Here we are querying “my-index” by default.</p>
</div>
<div id="queries" class="section level1">
<h1 class="hasAnchor">
<a href="#queries" class="anchor"></a>Queries</h1>
<div id="overview" class="section level2">
<h2 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h2>
<p>Two major types of queries are currently supported by this package.</p>
<ol style="list-style-type: decimal">
<li>
<strong>Aggregation</strong>: Documents are counted by specified fields in the data, query initiated with <code><a href="../reference/query_agg.html">query_agg()</a></code>
</li>
<li>
<strong>Fetch</strong>: Documents are retrieved according to specified criteria, query initiated with <code><a href="../reference/query_fetch.html">query_fetch()</a></code>
</li>
</ol>
<p>After a query is initiated, it can built upon by piping various operations:</p>
<ul>
<li>
<code><a href="../reference/agg_by_field.html">agg_by_field()</a></code>: specify a field to aggregate by, only for aggregation queries</li>
<li>
<code><a href="../reference/agg_by_date.html">agg_by_date()</a></code>: specify a date field and date binning to aggregate by, only for aggregation queries</li>
<li>
<code><a href="../reference/filter_match.html">filter_match()</a></code>: specify a field to filter documents on according to a string match (partial for text fields, exact for keyword fields), for both aggregation and fetch queries</li>
<li>
<code><a href="../reference/filter_terms.html">filter_terms()</a></code>: specify a field to filter documents on according to a string exact match, for both aggregation and fetch queries</li>
<li>
<code><a href="../reference/filter_regexp.html">filter_regexp()</a></code>: specify a field to filter documents on according to a regular expression match, for both aggregation and fetch queries</li>
<li>
<code><a href="../reference/filter_range.html">filter_range()</a></code>: specify a field to filter documents on according to a specified range, for both aggregation and fetch queries</li>
<li>
<code><a href="../reference/select_fields.html">select_fields()</a></code>: specify fields to select in the returned documents, only for fetch queries</li>
<li>
<code><a href="../reference/sort_docs.html">sort_docs()</a></code>: specify fields by which to sort the returned documents, only for fetch queries.</li>
</ul>
</div>
<div id="aggregation-queries" class="section level2">
<h2 class="hasAnchor">
<a href="#aggregation-queries" class="anchor"></a>Aggregation Queries</h2>
<p>Aggregation queries are constructed by doing the following:</p>
<ul>
<li>Initiate an aggregation query using <code><a href="../reference/query_agg.html">query_agg()</a></code>
</li>
<li>Build on this query by specifying combinations of:
<ul>
<li>Fields to aggregate on using <code><a href="../reference/agg_by_field.html">agg_by_field()</a></code>
</li>
<li>Date binning using <code><a href="../reference/agg_by_date.html">agg_by_date()</a></code>
</li>
</ul>
</li>
</ul>
<div id="initiating-a-query" class="section level3">
<h3 class="hasAnchor">
<a href="#initiating-a-query" class="anchor"></a>Initiating a Query</h3>
<p>To initiate an aggregation query, we use the function <code><a href="../reference/query_agg.html">query_agg()</a></code>, and pass it our connection object.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">query</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/query_agg.html">query_agg</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span></code></pre></div>
<p>We can view the query’s translation to an Elasticsearch search body string simply through printing the query.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">query</span>
<span class="co">#&gt; {}</span></code></pre></div>
<p>Here, of course, the query is empty as we haven’t specified aggregation dimensions yet.</p>
<p>Queries can be executed using the <code><a href="../reference/run.html">run()</a></code> function.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span><span class="va">query</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 0 x 0</span></code></pre></div>
<p>Since the query is empty, nothing is returned.</p>
</div>
<div id="getting-a-list-of-queryable-fields" class="section level3">
<h3 class="hasAnchor">
<a href="#getting-a-list-of-queryable-fields" class="anchor"></a>Getting a List of Queryable Fields</h3>
<p>To begin specifying fields to aggregate on, it can be helpful to get a view of what fields are available to aggregate on. This can be done by passing the connection object to `queryable_fields().</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/queryable_fields.html">queryable_fields</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 37 x 2</span>
<span class="co">#&gt;    field                type   </span>
<span class="co">#&gt;    &lt;chr&gt;                &lt;chr&gt;  </span>
<span class="co">#&gt;  1 affectedCountries    keyword</span>
<span class="co">#&gt;  2 affectedCountriesIso keyword</span>
<span class="co">#&gt;  3 childIds             keyword</span>
<span class="co">#&gt;  4 continentCodes       keyword</span>
<span class="co">#&gt;  5 description          text   </span>
<span class="co">#&gt;  6 duplicateId          keyword</span>
<span class="co">#&gt;  7 entityType           keyword</span>
<span class="co">#&gt;  8 flaggedByUserIds     integer</span>
<span class="co">#&gt;  9 fullText             text   </span>
<span class="co">#&gt; 10 id                   integer</span>
<span class="co">#&gt; # … with 27 more rows</span></code></pre></div>
<p>Note that aggregations make most sense when done against categorical variables with some bounded cardinality. Typically keywords make the most sense to aggregate against, but even with keywords, you should use care to think about what fields make sense to aggregate.</p>
</div>
<div id="aggregating-by-fields" class="section level3">
<h3 class="hasAnchor">
<a href="#aggregating-by-fields" class="anchor"></a>Aggregating by Fields</h3>
<p>Suppose we want to tabulate the frequency of all of the fields in the index. We can do this by adding <code><a href="../reference/agg_by_field.html">agg_by_field()</a></code> to our query, specifying the field name “tags”.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">query</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/query_agg.html">query_agg</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/agg_by_field.html">agg_by_field</a></span><span class="op">(</span><span class="st">"tags"</span><span class="op">)</span></code></pre></div>
<p>The function <code><a href="../reference/agg_by_field.html">agg_by_field()</a></code>, and all subsequent query modifying functions take a query object as its input and emit a modified query object as its output. This makes these functions suitable for piping, which is a convenient and expressive way to build queries.</p>
<p>To see what this new query looks like:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">query</span>
<span class="co">#&gt; {</span>
<span class="co">#&gt;   "size": 0,</span>
<span class="co">#&gt;   "aggs": {</span>
<span class="co">#&gt;     "agg_results": {</span>
<span class="co">#&gt;       "composite": {</span>
<span class="co">#&gt;         "size": 1000,</span>
<span class="co">#&gt;         "sources": [</span>
<span class="co">#&gt;           {</span>
<span class="co">#&gt;             "tags": {</span>
<span class="co">#&gt;               "terms": {</span>
<span class="co">#&gt;                 "field": "tags"</span>
<span class="co">#&gt;               }</span>
<span class="co">#&gt;             }</span>
<span class="co">#&gt;           }</span>
<span class="co">#&gt;         ]</span>
<span class="co">#&gt;       }</span>
<span class="co">#&gt;     }</span>
<span class="co">#&gt;   }</span>
<span class="co">#&gt; }</span></code></pre></div>
<p><strong>Note</strong> that aggregation queries use <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-composite-aggregation.html">composite aggregation</a> with paging, and running the query will automatically take care of recurrent queries until paging is done and bind the results together, saving a lot of tedious work.</p>
<p>We can retrieve the result of this query by calling <code><a href="../reference/run.html">run()</a></code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span><span class="va">query</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 912 x 2</span>
<span class="co">#&gt;    tags                                 count</span>
<span class="co">#&gt;    &lt;chr&gt;                                &lt;int&gt;</span>
<span class="co">#&gt;  1 f:10:All MSF Categories               6010</span>
<span class="co">#&gt;  2 f:10:Biological                       5060</span>
<span class="co">#&gt;  3 f:10:CWA                                 2</span>
<span class="co">#&gt;  4 f:10:Chemical                           64</span>
<span class="co">#&gt;  5 f:10:Disasters                         982</span>
<span class="co">#&gt;  6 f:10:HPV_grouped                         5</span>
<span class="co">#&gt;  7 f:10:HPV_notgrouped                     14</span>
<span class="co">#&gt;  8 f:10:Scenarios                           9</span>
<span class="co">#&gt;  9 f:10:zAll Hazards Threats (optional)    25</span>
<span class="co">#&gt; 10 f:11:All UNICEF Categories            5098</span>
<span class="co">#&gt; # … with 902 more rows</span></code></pre></div>
<p>We can continue to add more dimensions to the aggregation using pipes. For example, to count the frequency of both the fields “tags” and “affectedCountriesIso”:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/query_agg.html">query_agg</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/agg_by_field.html">agg_by_field</a></span><span class="op">(</span><span class="st">"tags"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/agg_by_field.html">agg_by_field</a></span><span class="op">(</span><span class="st">"affectedCountriesIso"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 54,595 x 3</span>
<span class="co">#&gt;    tags                    affectedCountriesIso count</span>
<span class="co">#&gt;    &lt;chr&gt;                   &lt;chr&gt;                &lt;int&gt;</span>
<span class="co">#&gt;  1 f:10:All MSF Categories AD                      11</span>
<span class="co">#&gt;  2 f:10:All MSF Categories AE                      36</span>
<span class="co">#&gt;  3 f:10:All MSF Categories AF                      64</span>
<span class="co">#&gt;  4 f:10:All MSF Categories AG                       2</span>
<span class="co">#&gt;  5 f:10:All MSF Categories AI                       1</span>
<span class="co">#&gt;  6 f:10:All MSF Categories AL                      13</span>
<span class="co">#&gt;  7 f:10:All MSF Categories AM                      19</span>
<span class="co">#&gt;  8 f:10:All MSF Categories AO                       3</span>
<span class="co">#&gt;  9 f:10:All MSF Categories AR                     236</span>
<span class="co">#&gt; 10 f:10:All MSF Categories AS                       3</span>
<span class="co">#&gt; # … with 54,585 more rows</span></code></pre></div>
</div>
<div id="aggregating-by-date-binning" class="section level3">
<h3 class="hasAnchor">
<a href="#aggregating-by-date-binning" class="anchor"></a>Aggregating by Date Binning</h3>
<p>Suppose we want to get daily counts for each tag in the data. We can use a function <code><a href="../reference/agg_by_date.html">agg_by_date()</a></code>, which by default aggregates daily.</p>
<p>Here, we aggregate on a document’s field “processedOnDate”.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/query_agg.html">query_agg</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/agg_by_field.html">agg_by_field</a></span><span class="op">(</span><span class="st">"tags"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/agg_by_date.html">agg_by_date</a></span><span class="op">(</span><span class="st">"processedOnDate"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 4,291 x 3</span>
<span class="co">#&gt;    tags                    processedOnDate     count</span>
<span class="co">#&gt;    &lt;chr&gt;                   &lt;dttm&gt;              &lt;int&gt;</span>
<span class="co">#&gt;  1 f:10:All MSF Categories 2020-03-05 00:00:00    37</span>
<span class="co">#&gt;  2 f:10:All MSF Categories 2020-03-06 00:00:00   416</span>
<span class="co">#&gt;  3 f:10:All MSF Categories 2020-03-08 00:00:00    21</span>
<span class="co">#&gt;  4 f:10:All MSF Categories 2020-03-13 00:00:00   179</span>
<span class="co">#&gt;  5 f:10:All MSF Categories 2020-03-15 00:00:00    69</span>
<span class="co">#&gt;  6 f:10:All MSF Categories 2020-03-16 00:00:00   104</span>
<span class="co">#&gt;  7 f:10:All MSF Categories 2020-03-17 00:00:00  1345</span>
<span class="co">#&gt;  8 f:10:All MSF Categories 2020-03-18 00:00:00  3839</span>
<span class="co">#&gt;  9 f:10:Biological         2020-03-15 00:00:00     1</span>
<span class="co">#&gt; 10 f:10:Biological         2020-03-16 00:00:00     2</span>
<span class="co">#&gt; # … with 4,281 more rows</span></code></pre></div>
<p>For finer control over the date binning, we can use functions <code><a href="../reference/calendar_interval.html">calendar_interval()</a></code> and <code><a href="../reference/fixed_interval.html">fixed_interval()</a></code>.</p>
<p>For example, to bin on calendar week:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/query_agg.html">query_agg</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/agg_by_field.html">agg_by_field</a></span><span class="op">(</span><span class="st">"tags"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/agg_by_date.html">agg_by_date</a></span><span class="op">(</span><span class="st">"processedOnDate"</span>, <span class="fu"><a href="../reference/calendar_interval.html">calendar_interval</a></span><span class="op">(</span><span class="st">"1w"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 2,033 x 3</span>
<span class="co">#&gt;    tags                    processedOnDate     count</span>
<span class="co">#&gt;    &lt;chr&gt;                   &lt;dttm&gt;              &lt;int&gt;</span>
<span class="co">#&gt;  1 f:10:All MSF Categories 2020-03-02 00:00:00   474</span>
<span class="co">#&gt;  2 f:10:All MSF Categories 2020-03-09 00:00:00   248</span>
<span class="co">#&gt;  3 f:10:All MSF Categories 2020-03-16 00:00:00  5288</span>
<span class="co">#&gt;  4 f:10:Biological         2020-03-09 00:00:00     1</span>
<span class="co">#&gt;  5 f:10:Biological         2020-03-16 00:00:00  5059</span>
<span class="co">#&gt;  6 f:10:CWA                2020-03-16 00:00:00     2</span>
<span class="co">#&gt;  7 f:10:Chemical           2020-03-16 00:00:00    64</span>
<span class="co">#&gt;  8 f:10:Disasters          2020-03-02 00:00:00   474</span>
<span class="co">#&gt;  9 f:10:Disasters          2020-03-09 00:00:00   247</span>
<span class="co">#&gt; 10 f:10:Disasters          2020-03-16 00:00:00   261</span>
<span class="co">#&gt; # … with 2,023 more rows</span></code></pre></div>
<p>And to bin on every 10 days:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/query_agg.html">query_agg</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/agg_by_field.html">agg_by_field</a></span><span class="op">(</span><span class="st">"tags"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/agg_by_date.html">agg_by_date</a></span><span class="op">(</span><span class="st">"processedOnDate"</span>, <span class="fu"><a href="../reference/fixed_interval.html">fixed_interval</a></span><span class="op">(</span><span class="st">"10d"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 1,470 x 3</span>
<span class="co">#&gt;    tags                    processedOnDate     count</span>
<span class="co">#&gt;    &lt;chr&gt;                   &lt;dttm&gt;              &lt;int&gt;</span>
<span class="co">#&gt;  1 f:10:All MSF Categories 2020-02-28 00:00:00   474</span>
<span class="co">#&gt;  2 f:10:All MSF Categories 2020-03-09 00:00:00  5536</span>
<span class="co">#&gt;  3 f:10:Biological         2020-03-09 00:00:00  5060</span>
<span class="co">#&gt;  4 f:10:CWA                2020-03-09 00:00:00     2</span>
<span class="co">#&gt;  5 f:10:Chemical           2020-03-09 00:00:00    64</span>
<span class="co">#&gt;  6 f:10:Disasters          2020-02-28 00:00:00   474</span>
<span class="co">#&gt;  7 f:10:Disasters          2020-03-09 00:00:00   508</span>
<span class="co">#&gt;  8 f:10:HPV_grouped        2020-03-09 00:00:00     5</span>
<span class="co">#&gt;  9 f:10:HPV_notgrouped     2020-03-09 00:00:00    14</span>
<span class="co">#&gt; 10 f:10:Scenarios          2020-03-09 00:00:00     9</span>
<span class="co">#&gt; # … with 1,460 more rows</span></code></pre></div>
</div>
<div id="filtering" class="section level3">
<h3 class="hasAnchor">
<a href="#filtering" class="anchor"></a>Filtering</h3>
<p>We can further modify an aggregation query by specifying filters. Three types of filters are currently available:</p>
<ul>
<li>Range filters: specify a range of values a field can have</li>
<li>Terms filters: specify a value or vector of values a field must take</li>
<li>Match filters: match a specified string in a field</li>
</ul>
<p><strong>Note</strong> that filters can apply to both aggregation and fetch queries.</p>
<div id="range-filters" class="section level4">
<h4 class="hasAnchor">
<a href="#range-filters" class="anchor"></a>Range Filters</h4>
<p>Range filters are specifyind using <code><a href="../reference/filter_range.html">filter_range()</a></code>, specifying the field to filter, and then specifying one or both of <code>from</code> and <code>to</code> values for the range.</p>
<p>For example, to take our earlier aggregation query and filter it to dates later than 2018-01-01:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/query_agg.html">query_agg</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/agg_by_field.html">agg_by_field</a></span><span class="op">(</span><span class="st">"tags"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/agg_by_date.html">agg_by_date</a></span><span class="op">(</span><span class="st">"processedOnDate"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/filter_range.html">filter_range</a></span><span class="op">(</span><span class="st">"processedOnDate"</span>, from <span class="op">=</span> <span class="st">"2020-03-10"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 2,958 x 3</span>
<span class="co">#&gt;    tags                    processedOnDate     count</span>
<span class="co">#&gt;    &lt;chr&gt;                   &lt;dttm&gt;              &lt;int&gt;</span>
<span class="co">#&gt;  1 f:10:All MSF Categories 2020-03-13 00:00:00   179</span>
<span class="co">#&gt;  2 f:10:All MSF Categories 2020-03-15 00:00:00    69</span>
<span class="co">#&gt;  3 f:10:All MSF Categories 2020-03-16 00:00:00   104</span>
<span class="co">#&gt;  4 f:10:All MSF Categories 2020-03-17 00:00:00  1345</span>
<span class="co">#&gt;  5 f:10:All MSF Categories 2020-03-18 00:00:00  3839</span>
<span class="co">#&gt;  6 f:10:Biological         2020-03-15 00:00:00     1</span>
<span class="co">#&gt;  7 f:10:Biological         2020-03-16 00:00:00     2</span>
<span class="co">#&gt;  8 f:10:Biological         2020-03-17 00:00:00  1317</span>
<span class="co">#&gt;  9 f:10:Biological         2020-03-18 00:00:00  3740</span>
<span class="co">#&gt; 10 f:10:CWA                2020-03-18 00:00:00     2</span>
<span class="co">#&gt; # … with 2,948 more rows</span></code></pre></div>
<p>To filter on a date/time, the format is like the following:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/query_agg.html">query_agg</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/agg_by_field.html">agg_by_field</a></span><span class="op">(</span><span class="st">"tags"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/agg_by_date.html">agg_by_date</a></span><span class="op">(</span><span class="st">"processedOnDate"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/filter_range.html">filter_range</a></span><span class="op">(</span><span class="st">"processedOnDate"</span>, from <span class="op">=</span> <span class="st">"2020-03-10T10:21:32"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 2,958 x 3</span>
<span class="co">#&gt;    tags                    processedOnDate     count</span>
<span class="co">#&gt;    &lt;chr&gt;                   &lt;dttm&gt;              &lt;int&gt;</span>
<span class="co">#&gt;  1 f:10:All MSF Categories 2020-03-13 00:00:00   179</span>
<span class="co">#&gt;  2 f:10:All MSF Categories 2020-03-15 00:00:00    69</span>
<span class="co">#&gt;  3 f:10:All MSF Categories 2020-03-16 00:00:00   104</span>
<span class="co">#&gt;  4 f:10:All MSF Categories 2020-03-17 00:00:00  1345</span>
<span class="co">#&gt;  5 f:10:All MSF Categories 2020-03-18 00:00:00  3839</span>
<span class="co">#&gt;  6 f:10:Biological         2020-03-15 00:00:00     1</span>
<span class="co">#&gt;  7 f:10:Biological         2020-03-16 00:00:00     2</span>
<span class="co">#&gt;  8 f:10:Biological         2020-03-17 00:00:00  1317</span>
<span class="co">#&gt;  9 f:10:Biological         2020-03-18 00:00:00  3740</span>
<span class="co">#&gt; 10 f:10:CWA                2020-03-18 00:00:00     2</span>
<span class="co">#&gt; # … with 2,948 more rows</span></code></pre></div>
</div>
<div id="terms-filters" class="section level4">
<h4 class="hasAnchor">
<a href="#terms-filters" class="anchor"></a>Terms Filters</h4>
<p>The funtion <code><a href="../reference/filter_terms.html">filter_terms()</a></code> adds a filter to a query that specifies certain values a field must have to be included in the aggregation.</p>
<p>For example, to add to our earlier query, suppose we require that “affectedCountriesIso” must contain “US” or “CA”:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/query_agg.html">query_agg</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/agg_by_field.html">agg_by_field</a></span><span class="op">(</span><span class="st">"tags"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/agg_by_date.html">agg_by_date</a></span><span class="op">(</span><span class="st">"processedOnDate"</span>, <span class="fu"><a href="../reference/calendar_interval.html">calendar_interval</a></span><span class="op">(</span><span class="st">"1w"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/filter_range.html">filter_range</a></span><span class="op">(</span><span class="st">"processedOnDate"</span>, from <span class="op">=</span> <span class="st">"2018-01-01"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/filter_terms.html">filter_terms</a></span><span class="op">(</span><span class="st">"affectedCountriesIso"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"US"</span>, <span class="st">"CA"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 1,638 x 3</span>
<span class="co">#&gt;    tags                    processedOnDate     count</span>
<span class="co">#&gt;    &lt;chr&gt;                   &lt;dttm&gt;              &lt;int&gt;</span>
<span class="co">#&gt;  1 f:10:All MSF Categories 2020-03-02 00:00:00    86</span>
<span class="co">#&gt;  2 f:10:All MSF Categories 2020-03-09 00:00:00    25</span>
<span class="co">#&gt;  3 f:10:All MSF Categories 2020-03-16 00:00:00  1195</span>
<span class="co">#&gt;  4 f:10:Biological         2020-03-16 00:00:00  1169</span>
<span class="co">#&gt;  5 f:10:CWA                2020-03-16 00:00:00     1</span>
<span class="co">#&gt;  6 f:10:Chemical           2020-03-16 00:00:00    17</span>
<span class="co">#&gt;  7 f:10:Disasters          2020-03-02 00:00:00    86</span>
<span class="co">#&gt;  8 f:10:Disasters          2020-03-09 00:00:00    25</span>
<span class="co">#&gt;  9 f:10:Disasters          2020-03-16 00:00:00    37</span>
<span class="co">#&gt; 10 f:10:HPV_grouped        2020-03-16 00:00:00     2</span>
<span class="co">#&gt; # … with 1,628 more rows</span></code></pre></div>
</div>
<div id="regexp-filters" class="section level4">
<h4 class="hasAnchor">
<a href="#regexp-filters" class="anchor"></a>Regexp Filters</h4>
<p>The function <code><a href="../reference/filter_regexp.html">filter_regexp()</a></code> adds a filter to a query that provides a regular expression that a field must match to be included in the results. Note that unfortuately Elasticsearch regular expressions are case sensitive.</p>
<p>To aggregate tags but only for documents that have a tag that contain “Corona”, for example:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/query_agg.html">query_agg</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/agg_by_field.html">agg_by_field</a></span><span class="op">(</span><span class="st">"tags"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/filter_regexp.html">filter_regexp</a></span><span class="op">(</span><span class="st">"tags"</span>, <span class="st">".*Corona.*"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 677 x 2</span>
<span class="co">#&gt;    tags                                 count</span>
<span class="co">#&gt;    &lt;chr&gt;                                &lt;int&gt;</span>
<span class="co">#&gt;  1 f:10:All MSF Categories               4899</span>
<span class="co">#&gt;  2 f:10:Biological                       4899</span>
<span class="co">#&gt;  3 f:10:CWA                                 1</span>
<span class="co">#&gt;  4 f:10:Chemical                           27</span>
<span class="co">#&gt;  5 f:10:Disasters                          62</span>
<span class="co">#&gt;  6 f:10:HPV_grouped                         1</span>
<span class="co">#&gt;  7 f:10:HPV_notgrouped                      7</span>
<span class="co">#&gt;  8 f:10:Scenarios                           3</span>
<span class="co">#&gt;  9 f:10:zAll Hazards Threats (optional)     6</span>
<span class="co">#&gt; 10 f:11:All UNICEF Categories            4899</span>
<span class="co">#&gt; # … with 667 more rows</span></code></pre></div>
<p>Note that here we are filtering on a field that is an array of values for each document. Because of this, we will get more tags in our resulting aggregation than tags that include “Corona”. Here, we are counting <em>all</em> tags that are present in each article that contains a tag matching “Corona”.</p>
</div>
<div id="match-filters" class="section level4">
<h4 class="hasAnchor">
<a href="#match-filters" class="anchor"></a>Match Filters</h4>
<p>The function <code><a href="../reference/filter_match.html">filter_match()</a></code> specifies a filter to only include documents where the specified field contains a match for the provided string.</p>
<p>For example, to further refine our aggregation to only include documents where a match for the string “disease” is found in the full text:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/query_agg.html">query_agg</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/agg_by_field.html">agg_by_field</a></span><span class="op">(</span><span class="st">"tags"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/agg_by_date.html">agg_by_date</a></span><span class="op">(</span><span class="st">"processedOnDate"</span>, <span class="fu"><a href="../reference/calendar_interval.html">calendar_interval</a></span><span class="op">(</span><span class="st">"1w"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/filter_range.html">filter_range</a></span><span class="op">(</span><span class="st">"processedOnDate"</span>, from <span class="op">=</span> <span class="st">"2020-03-10"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/filter_terms.html">filter_terms</a></span><span class="op">(</span><span class="st">"affectedCountriesIso"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"US"</span>, <span class="st">"CA"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/filter_match.html">filter_match</a></span><span class="op">(</span><span class="st">"fullText"</span>, <span class="st">"disease"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 772 x 3</span>
<span class="co">#&gt;    tags                                 processedOnDate     count</span>
<span class="co">#&gt;    &lt;chr&gt;                                &lt;dttm&gt;              &lt;int&gt;</span>
<span class="co">#&gt;  1 f:10:All MSF Categories              2020-03-09 00:00:00     1</span>
<span class="co">#&gt;  2 f:10:All MSF Categories              2020-03-16 00:00:00   196</span>
<span class="co">#&gt;  3 f:10:Biological                      2020-03-16 00:00:00   194</span>
<span class="co">#&gt;  4 f:10:CWA                             2020-03-16 00:00:00     1</span>
<span class="co">#&gt;  5 f:10:Chemical                        2020-03-16 00:00:00     5</span>
<span class="co">#&gt;  6 f:10:Disasters                       2020-03-09 00:00:00     1</span>
<span class="co">#&gt;  7 f:10:Disasters                       2020-03-16 00:00:00     7</span>
<span class="co">#&gt;  8 f:10:HPV_notgrouped                  2020-03-16 00:00:00     2</span>
<span class="co">#&gt;  9 f:10:zAll Hazards Threats (optional) 2020-03-16 00:00:00     2</span>
<span class="co">#&gt; 10 f:11:All UNICEF Categories           2020-03-16 00:00:00   196</span>
<span class="co">#&gt; # … with 762 more rows</span></code></pre></div>
</div>
</div>
</div>
<div id="fetch-queries" class="section level2">
<h2 class="hasAnchor">
<a href="#fetch-queries" class="anchor"></a>Fetch Queries</h2>
<p>Fetch queries simply retrieve documents based on filtering criteria. All of the filtering functions specified above apply to these queries.</p>
<div id="initiating-a-query-1" class="section level3">
<h3 class="hasAnchor">
<a href="#initiating-a-query-1" class="anchor"></a>Initiating a Query</h3>
<p>Similar to aggregation queries, a fetch query is initialized using <code><a href="../reference/query_fetch.html">query_fetch()</a></code>, which takes as its primary argument the connection object.</p>
<p>One optional argument of note to this function is <code>path</code>, which specifies a directory to write docuents to as they are fetched. If this is not specified, results will be read into memory. If the result set looks like it will be very large, a warning is provided that encourages the user to provide a <code>path</code> and write to disk.</p>
<p>If we intialize a fetch query with no refinements, it will returl all documents in the index.</p>
<p>For example, with our example index which contains 10k documents:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">docs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/query_fetch.html">query_fetch</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>This will fetch all 10k documents and return them as a large list to <code>docs</code>.</p>
<p><strong>Note</strong> that fetch queries automatically take care of <a href="https://www.elastic.co/guide/en/elasticsearch/client/javascript-api/current/scroll_examples.html">scrolling</a> to retrieve potentially very large sets of documents. The scroll limit is 10k documents, so iterative queries are run to fetch these in batches and piece them together upon retrieval.</p>
</div>
<div id="adding-filters-to-fetch-queries" class="section level3">
<h3 class="hasAnchor">
<a href="#adding-filters-to-fetch-queries" class="anchor"></a>Adding Filters to Fetch Queries</h3>
<p>It is probably more desirable for a fetch query to pinpoint records of interest rather than retrieve all documents. This can be done using filter queries as we specified earlier.</p>
<p>For example, to fetch all documents matching the filtering criteria we specified in the final aggregation example:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">docs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/query_fetch.html">query_fetch</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/filter_range.html">filter_range</a></span><span class="op">(</span><span class="st">"processedOnDate"</span>, from <span class="op">=</span> <span class="st">"2020-03-10"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/filter_terms.html">filter_terms</a></span><span class="op">(</span><span class="st">"affectedCountriesIso"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"US"</span>, <span class="st">"CA"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/filter_match.html">filter_match</a></span><span class="op">(</span><span class="st">"fullText"</span>, <span class="st">"disease"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Fetching 288 total documents...</span>
<span class="co">#&gt; 288 documents fetched (100%)...</span></code></pre></div>
</div>
<div id="fetching-a-subset-of-records" class="section level3">
<h3 class="hasAnchor">
<a href="#fetching-a-subset-of-records" class="anchor"></a>Fetching a subset of records</h3>
<p>There is an argument <code>max</code> in <code><a href="../reference/query_fetch.html">query_fetch()</a></code> that can be used to specify that we just want to fetch the first <code>max</code> documents. This can be useful if we want to experiment with our query and the resulting data before doing a full fetch.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">docs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/query_fetch.html">query_fetch</a></span><span class="op">(</span><span class="va">con</span>, max <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/filter_range.html">filter_range</a></span><span class="op">(</span><span class="st">"processedOnDate"</span>, from <span class="op">=</span> <span class="st">"2020-03-10"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/filter_terms.html">filter_terms</a></span><span class="op">(</span><span class="st">"affectedCountriesIso"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"US"</span>, <span class="st">"CA"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/filter_match.html">filter_match</a></span><span class="op">(</span><span class="st">"fullText"</span>, <span class="st">"disease"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Fetching first 10 of 288 total documents...</span>
<span class="co">#&gt; 10 documents fetched (100%)...</span></code></pre></div>
</div>
<div id="fetching-to-disk" class="section level3">
<h3 class="hasAnchor">
<a href="#fetching-to-disk" class="anchor"></a>Fetching to Disk</h3>
<p>In the previous fetch examples, the return object <code>docs</code> has been a list format of the document content of the query.</p>
<p>In a many cases we may wish to do a bulk download of many articles. If we specify a <code>path</code> argument to <code><a href="../reference/query_fetch.html">query_fetch()</a></code>, the results will be written in batches to the specified directory.</p>
<p>For example, to write our last query to disk, we specify a directory in our query initizilaztion. Also, note that to simulate scrolling, we specify each iteration of the query to retrieve 10 documents (instead of the default 10k documents) with the <code>size</code> argument. With this, we see that two files get written, one for each scroll.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span><span class="op">(</span><span class="va">tf</span><span class="op">)</span>
<span class="va">docs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/query_fetch.html">query_fetch</a></span><span class="op">(</span><span class="va">con</span>, path <span class="op">=</span> <span class="va">tf</span>, size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/filter_range.html">filter_range</a></span><span class="op">(</span><span class="st">"processedOnDate"</span>, from <span class="op">=</span> <span class="st">"2020-03-10"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/filter_terms.html">filter_terms</a></span><span class="op">(</span><span class="st">"affectedCountriesIso"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"US"</span>, <span class="st">"CA"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/filter_match.html">filter_match</a></span><span class="op">(</span><span class="st">"fullText"</span>, <span class="st">"disease"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Fetching 288 total documents...</span>
<span class="co">#&gt; 10 documents fetched (3%)...</span>
<span class="co">#&gt; 20 documents fetched (7%)...</span>
<span class="co">#&gt; 30 documents fetched (10%)...</span>
<span class="co">#&gt; 40 documents fetched (14%)...</span>
<span class="co">#&gt; 50 documents fetched (17%)...</span>
<span class="co">#&gt; 60 documents fetched (21%)...</span>
<span class="co">#&gt; 70 documents fetched (24%)...</span>
<span class="co">#&gt; 80 documents fetched (28%)...</span>
<span class="co">#&gt; 90 documents fetched (31%)...</span>
<span class="co">#&gt; 100 documents fetched (35%)...</span>
<span class="co">#&gt; 110 documents fetched (38%)...</span>
<span class="co">#&gt; 120 documents fetched (42%)...</span>
<span class="co">#&gt; 130 documents fetched (45%)...</span>
<span class="co">#&gt; 140 documents fetched (49%)...</span>
<span class="co">#&gt; 150 documents fetched (52%)...</span>
<span class="co">#&gt; 160 documents fetched (56%)...</span>
<span class="co">#&gt; 170 documents fetched (59%)...</span>
<span class="co">#&gt; 180 documents fetched (62%)...</span>
<span class="co">#&gt; 190 documents fetched (66%)...</span>
<span class="co">#&gt; 200 documents fetched (69%)...</span>
<span class="co">#&gt; 210 documents fetched (73%)...</span>
<span class="co">#&gt; 220 documents fetched (76%)...</span>
<span class="co">#&gt; 230 documents fetched (80%)...</span>
<span class="co">#&gt; 240 documents fetched (83%)...</span>
<span class="co">#&gt; 250 documents fetched (87%)...</span>
<span class="co">#&gt; 260 documents fetched (90%)...</span>
<span class="co">#&gt; 270 documents fetched (94%)...</span>
<span class="co">#&gt; 280 documents fetched (97%)...</span>
<span class="co">#&gt; 288 documents fetched (100%)...</span>

<span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="va">docs</span><span class="op">)</span>
<span class="co">#&gt;  [1] "out0001.json" "out0002.json" "out0003.json" "out0004.json" "out0005.json"</span>
<span class="co">#&gt;  [6] "out0006.json" "out0007.json" "out0008.json" "out0009.json" "out0010.json"</span>
<span class="co">#&gt; [11] "out0011.json" "out0012.json" "out0013.json" "out0014.json" "out0015.json"</span>
<span class="co">#&gt; [16] "out0016.json" "out0017.json" "out0018.json" "out0019.json" "out0020.json"</span>
<span class="co">#&gt; [21] "out0021.json" "out0022.json" "out0023.json" "out0024.json" "out0025.json"</span>
<span class="co">#&gt; [26] "out0026.json" "out0027.json" "out0028.json" "out0029.json"</span></code></pre></div>
</div>
<div id="specifying-fields-to-sort-on" class="section level3">
<h3 class="hasAnchor">
<a href="#specifying-fields-to-sort-on" class="anchor"></a>Specifying fields to sort on</h3>
<p>Another operation available only for fetch queries is <code><a href="../reference/sort_docs.html">sort_docs()</a></code>, which allows you to specify fields to sort by as part of the fetch.</p>
<p>For example:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">docs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/query_fetch.html">query_fetch</a></span><span class="op">(</span><span class="va">con</span>, size <span class="op">=</span> <span class="fl">10</span>, max <span class="op">=</span> <span class="fl">25</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/filter_range.html">filter_range</a></span><span class="op">(</span><span class="st">"processedOnDate"</span>, from <span class="op">=</span> <span class="st">"2020-03-10"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/sort_docs.html">sort_docs</a></span><span class="op">(</span><span class="st">"processedOnDate"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Fetching first 25 of 8136 total documents...</span>
<span class="co">#&gt; 10 documents fetched (40%)...</span>
<span class="co">#&gt; 20 documents fetched (80%)...</span>
<span class="co">#&gt; 25 documents fetched (100%)...</span>

<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">docs</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">`_source`</span><span class="op">$</span><span class="va">processedOnDate</span><span class="op">)</span>
<span class="co">#&gt;  [1] "2020-03-13T07:26:04.0422415Z" "2020-03-13T07:26:07.0304637Z"</span>
<span class="co">#&gt;  [3] "2020-03-13T07:26:07.8927456Z" "2020-03-13T07:26:09.0216872Z"</span>
<span class="co">#&gt;  [5] "2020-03-13T07:28:01.4437200Z" "2020-03-13T07:28:02.9752079Z"</span>
<span class="co">#&gt;  [7] "2020-03-13T07:28:13.5119956Z" "2020-03-13T07:28:15.0721117Z"</span>
<span class="co">#&gt;  [9] "2020-03-13T07:30:03.4775738Z" "2020-03-13T07:30:05.2785935Z"</span>
<span class="co">#&gt; [11] "2020-03-13T07:30:08.0987420Z" "2020-03-13T07:31:08.4420386Z"</span>
<span class="co">#&gt; [13] "2020-03-13T07:31:08.7470622Z" "2020-03-13T07:32:10.5883424Z"</span>
<span class="co">#&gt; [15] "2020-03-13T07:32:10.9902103Z" "2020-03-13T07:32:15.2091531Z"</span>
<span class="co">#&gt; [17] "2020-03-13T07:32:18.7561610Z" "2020-03-13T07:33:02.1066126Z"</span>
<span class="co">#&gt; [19] "2020-03-13T07:33:05.4555161Z" "2020-03-13T07:33:06.1505288Z"</span>
<span class="co">#&gt; [21] "2020-03-13T07:34:08.6844120Z" "2020-03-13T07:35:05.6037369Z"</span>
<span class="co">#&gt; [23] "2020-03-13T07:35:09.8630094Z" "2020-03-13T07:35:10.7938444Z"</span>
<span class="co">#&gt; [25] "2020-03-13T07:37:01.3067962Z"</span></code></pre></div>
</div>
<div id="specifying-fields-to-return" class="section level3">
<h3 class="hasAnchor">
<a href="#specifying-fields-to-return" class="anchor"></a>Specifying fields to return</h3>
<p>An operation available only for fetch queries, <code><a href="../reference/select_fields.html">select_fields()</a></code>, allows us to specify which fields should be returned for each document. This is useful of documents contain some fields that are very large and we don’t want to include them in our results.</p>
<p>To see what values are acceptable for a selectable field:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/selectable_fields.html">selectable_fields</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 45 x 2</span>
<span class="co">#&gt;    field                type   </span>
<span class="co">#&gt;    &lt;chr&gt;                &lt;chr&gt;  </span>
<span class="co">#&gt;  1 affectedCountries    keyword</span>
<span class="co">#&gt;  2 affectedCountriesIso keyword</span>
<span class="co">#&gt;  3 childIds             keyword</span>
<span class="co">#&gt;  4 comments             nested </span>
<span class="co">#&gt;  5 continentCodes       keyword</span>
<span class="co">#&gt;  6 description          text   </span>
<span class="co">#&gt;  7 duplicateId          keyword</span>
<span class="co">#&gt;  8 entityType           keyword</span>
<span class="co">#&gt;  9 flaggedByUserIds     integer</span>
<span class="co">#&gt; 10 fullText             text   </span>
<span class="co">#&gt; # … with 35 more rows</span></code></pre></div>
<p>For example, to return just the fields “source.countryIso” and “locations”:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">docs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/query_fetch.html">query_fetch</a></span><span class="op">(</span><span class="va">con</span>, size <span class="op">=</span> <span class="fl">10</span>, max <span class="op">=</span> <span class="fl">25</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/filter_range.html">filter_range</a></span><span class="op">(</span><span class="st">"processedOnDate"</span>, from <span class="op">=</span> <span class="st">"2020-03-10"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/select_fields.html">select_fields</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"source.id"</span>, <span class="st">"triggers"</span>, <span class="st">"locations"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Fetching first 25 of 8136 total documents...</span>
<span class="co">#&gt; 10 documents fetched (40%)...</span>
<span class="co">#&gt; 20 documents fetched (80%)...</span>
<span class="co">#&gt; 25 documents fetched (100%)...</span>

<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">docs</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">`_source`</span>, <span class="fl">2</span><span class="op">)</span>
<span class="co">#&gt; List of 3</span>
<span class="co">#&gt;  $ locations:List of 2</span>
<span class="co">#&gt;   ..$ :List of 8</span>
<span class="co">#&gt;   ..$ :List of 9</span>
<span class="co">#&gt;  $ source   :List of 1</span>
<span class="co">#&gt;   ..$ id: int 11786</span>
<span class="co">#&gt;  $ triggers :List of 4</span>
<span class="co">#&gt;   ..$ :List of 2</span>
<span class="co">#&gt;   ..$ :List of 2</span>
<span class="co">#&gt;   ..$ :List of 2</span>
<span class="co">#&gt;   ..$ :List of 2</span>

<span class="va">to_data_frame</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">x</span>, <span class="kw">function</span><span class="op">(</span><span class="va">a</span><span class="op">)</span> <span class="va">a</span><span class="op">$</span><span class="va">`_source`</span><span class="op">)</span>
  <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/deprecated.html">as_data_frame</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
</div>
<div id="ad-hoc-queries" class="section level2">
<h2 class="hasAnchor">
<a href="#ad-hoc-queries" class="anchor"></a>Ad hoc Queries</h2>
<p>The interface provided by <code><a href="../reference/query_fetch.html">query_fetch()</a></code>, <code><a href="../reference/query_agg.html">query_agg()</a></code>, and the accompanying filter and sort functions is meant to enable clean and precise definition of Elasticsearch queries, hiding all the messy details of scrolling, aggregation bucketing, query JSON specification, execution, etc. There may be times when this interface does not quite provide enough flexibility. In this scenario, a function, <code><a href="../reference/query_str.html">query_str()</a></code>, has been created that allows you to provide a string specifying an Elasticsearch query that gets executed.</p>
<p>For example, suppose we would like to fetch all documents retrieved after 2020-03-10. As we have seen before, we can do this with the following:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">docs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/query_fetch.html">query_fetch</a></span><span class="op">(</span><span class="va">con</span>, size <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/filter_range.html">filter_range</a></span><span class="op">(</span><span class="st">"processedOnDate"</span>, from <span class="op">=</span> <span class="st">"2020-03-10"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>Suppose we want to run a query similar to this, but we need to modify the query a bit in a way that isn’t available through the interface provided in this package. Let’s first look at what the resulting query string is:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/query_fetch.html">query_fetch</a></span><span class="op">(</span><span class="va">con</span>, size <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/filter_range.html">filter_range</a></span><span class="op">(</span><span class="st">"processedOnDate"</span>, from <span class="op">=</span> <span class="st">"2020-03-10"</span><span class="op">)</span>
<span class="co">#&gt; {</span>
<span class="co">#&gt;   "size": 1000,</span>
<span class="co">#&gt;   "query": {</span>
<span class="co">#&gt;     "bool": {</span>
<span class="co">#&gt;       "filter": [</span>
<span class="co">#&gt;         {</span>
<span class="co">#&gt;           "range": {</span>
<span class="co">#&gt;             "processedOnDate": {</span>
<span class="co">#&gt;               "gte": "2020-03-10"</span>
<span class="co">#&gt;             }</span>
<span class="co">#&gt;           }</span>
<span class="co">#&gt;         }</span>
<span class="co">#&gt;       ]</span>
<span class="co">#&gt;     }</span>
<span class="co">#&gt;   }</span>
<span class="co">#&gt; }</span></code></pre></div>
<p>For illustration purposes, we will take this string and run it directly without modification. To run this query string, we can do the following:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">str</span> <span class="op">&lt;-</span> <span class="st">'{
  "size": 1000,
  "query": {
    "bool": {
      "filter": [
        {
          "range": {
            "processedOnDate": {
              "gte": "2020-03-10"
            }
          }
        }
      ]
    }
  }
}'</span>

<span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/query_str.html">query_str</a></span><span class="op">(</span><span class="va">con</span>, str <span class="op">=</span> <span class="va">str</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>Here we simply specified to run the query specified by this string. The structure of the output looks like this:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">res</span>, <span class="fl">2</span><span class="op">)</span>
<span class="co">#&gt; List of 4</span>
<span class="co">#&gt;  $ took     : int 38</span>
<span class="co">#&gt;  $ timed_out: logi FALSE</span>
<span class="co">#&gt;  $ _shards  :List of 4</span>
<span class="co">#&gt;   ..$ total     : int 1</span>
<span class="co">#&gt;   ..$ successful: int 1</span>
<span class="co">#&gt;   ..$ skipped   : int 0</span>
<span class="co">#&gt;   ..$ failed    : int 0</span>
<span class="co">#&gt;  $ hits     :List of 3</span>
<span class="co">#&gt;   ..$ total    :List of 2</span>
<span class="co">#&gt;   ..$ max_score: num 0</span>
<span class="co">#&gt;   ..$ hits     :List of 1000</span></code></pre></div>
<p>Note that this is the raw output provided by Elasticsearch and not the more convenient list output provided by <code><a href="../reference/query_fetch.html">query_fetch()</a></code>. Also note that it only pulled 1000 documents when we know there are more results in this query. These limitations occur because <code><a href="../reference/query_str.html">query_str()</a></code> does not know what kind of query specificaiton it is going to receive, and therefore does not know how to best process the output.</p>
<p>To fully take advantage of the fetch and aggregation conveniences provided by this package, an additional <code>type</code> parameter is available to <code><a href="../reference/query_str.html">query_str()</a></code> which by default is “unkown”, but can also be set to “fetch” or “agg”.</p>
<p>With our current example, if we add <code>type = "fetch"</code> to our call to <code><a href="../reference/query_str.html">query_str()</a></code>, the execution now knows to handle the query as a fetch query and will take care of scrolling, etc. to fetch all of the documents.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/query_str.html">query_str</a></span><span class="op">(</span><span class="va">con</span>, str <span class="op">=</span> <span class="va">str</span>, type <span class="op">=</span> <span class="st">"fetch"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Fetching 8136 total documents...</span>
<span class="co">#&gt; 1000 documents fetched (12%)...</span>
<span class="co">#&gt; 2000 documents fetched (25%)...</span>
<span class="co">#&gt; 3000 documents fetched (37%)...</span>
<span class="co">#&gt; 4000 documents fetched (49%)...</span>
<span class="co">#&gt; 5000 documents fetched (61%)...</span>
<span class="co">#&gt; 6000 documents fetched (74%)...</span>
<span class="co">#&gt; 7000 documents fetched (86%)...</span>
<span class="co">#&gt; 8000 documents fetched (98%)...</span>
<span class="co">#&gt; 8136 documents fetched (100%)...</span>

<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span>
<span class="co">#&gt; [1] 8136</span></code></pre></div>
<p>While this example wasn’t very imaginative, suppose there is more complex filter logic you want to apply. A typical use case might be to use <code><a href="../reference/query_fetch.html">query_fetch()</a></code> and associated filter/sort functions to get you started, modify the query string as needed, and pass that to <code><a href="../reference/query_str.html">query_str()</a></code>. Note, however, that there is less protection in this scenario from errors in the query specification, so you can expect to see more error messages which will result in the need to debug your query string.</p>
<p>Similarly, we can apply <code><a href="../reference/query_str.html">query_str()</a></code> to aggregation-type queries. Let’s take the following example:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/query_agg.html">query_agg</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/agg_by_field.html">agg_by_field</a></span><span class="op">(</span><span class="st">"tags"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/agg_by_field.html">agg_by_field</a></span><span class="op">(</span><span class="st">"affectedCountriesIso"</span><span class="op">)</span>
<span class="co">#&gt; {</span>
<span class="co">#&gt;   "size": 0,</span>
<span class="co">#&gt;   "aggs": {</span>
<span class="co">#&gt;     "agg_results": {</span>
<span class="co">#&gt;       "composite": {</span>
<span class="co">#&gt;         "size": 1000,</span>
<span class="co">#&gt;         "sources": [</span>
<span class="co">#&gt;           {</span>
<span class="co">#&gt;             "tags": {</span>
<span class="co">#&gt;               "terms": {</span>
<span class="co">#&gt;                 "field": "tags"</span>
<span class="co">#&gt;               }</span>
<span class="co">#&gt;             }</span>
<span class="co">#&gt;           },</span>
<span class="co">#&gt;           {</span>
<span class="co">#&gt;             "affectedCountriesIso": {</span>
<span class="co">#&gt;               "terms": {</span>
<span class="co">#&gt;                 "field": "affectedCountriesIso"</span>
<span class="co">#&gt;               }</span>
<span class="co">#&gt;             }</span>
<span class="co">#&gt;           }</span>
<span class="co">#&gt;         ]</span>
<span class="co">#&gt;       }</span>
<span class="co">#&gt;     }</span>
<span class="co">#&gt;   }</span>
<span class="co">#&gt; }</span></code></pre></div>
<p>We can run this same query using <code><a href="../reference/query_str.html">query_str()</a></code> as follows:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">str</span> <span class="op">&lt;-</span> <span class="st">'{
  "size": 0,
  "aggs": {
    "agg_results": {
      "composite": {
        "size": 1000,
        "sources": [
          {
            "tags": {
              "terms": {
                "field": "tags"
              }
            }
          },
          {
            "affectedCountriesIso": {
              "terms": {
                "field": "affectedCountriesIso"
              }
            }
          }
        ]
      }
    }
  }
}'</span>

<span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/query_str.html">query_str</a></span><span class="op">(</span><span class="va">con</span>, str <span class="op">=</span> <span class="va">str</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">res</span>, <span class="fl">3</span><span class="op">)</span>
<span class="co">#&gt; List of 5</span>
<span class="co">#&gt;  $ took        : int 0</span>
<span class="co">#&gt;  $ timed_out   : logi FALSE</span>
<span class="co">#&gt;  $ _shards     :List of 4</span>
<span class="co">#&gt;   ..$ total     : int 1</span>
<span class="co">#&gt;   ..$ successful: int 1</span>
<span class="co">#&gt;   ..$ skipped   : int 0</span>
<span class="co">#&gt;   ..$ failed    : int 0</span>
<span class="co">#&gt;  $ hits        :List of 3</span>
<span class="co">#&gt;   ..$ total    :List of 2</span>
<span class="co">#&gt;   .. ..$ value   : int 10000</span>
<span class="co">#&gt;   .. ..$ relation: chr "eq"</span>
<span class="co">#&gt;   ..$ max_score: NULL</span>
<span class="co">#&gt;   ..$ hits     : list()</span>
<span class="co">#&gt;  $ aggregations:List of 1</span>
<span class="co">#&gt;   ..$ agg_results:List of 2</span>
<span class="co">#&gt;   .. ..$ after_key:List of 2</span>
<span class="co">#&gt;   .. ..$ buckets  :List of 1000</span></code></pre></div>
<p>As before, we see that <code><a href="../reference/query_str.html">query_str()</a></code> is “dumb” in that it doesn’t know we are doing an aggregation and doesn’t know to do the smart iteration to fetch the rest of the aggregation buckets as well as putting the result into a data frame.</p>
<p>To make <code><a href="../reference/query_str.html">query_str()</a></code> “smart”, we can add <code>type = "agg"</code>:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/query_str.html">query_str</a></span><span class="op">(</span><span class="va">con</span>, str <span class="op">=</span> <span class="va">str</span>, type <span class="op">=</span> <span class="st">"agg"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">res</span>
<span class="co">#&gt; # A tibble: 54,595 x 3</span>
<span class="co">#&gt;    tags                    affectedCountriesIso count</span>
<span class="co">#&gt;    &lt;chr&gt;                   &lt;chr&gt;                &lt;int&gt;</span>
<span class="co">#&gt;  1 f:10:All MSF Categories AD                      11</span>
<span class="co">#&gt;  2 f:10:All MSF Categories AE                      36</span>
<span class="co">#&gt;  3 f:10:All MSF Categories AF                      64</span>
<span class="co">#&gt;  4 f:10:All MSF Categories AG                       2</span>
<span class="co">#&gt;  5 f:10:All MSF Categories AI                       1</span>
<span class="co">#&gt;  6 f:10:All MSF Categories AL                      13</span>
<span class="co">#&gt;  7 f:10:All MSF Categories AM                      19</span>
<span class="co">#&gt;  8 f:10:All MSF Categories AO                       3</span>
<span class="co">#&gt;  9 f:10:All MSF Categories AR                     236</span>
<span class="co">#&gt; 10 f:10:All MSF Categories AS                       3</span>
<span class="co">#&gt; # … with 54,585 more rows</span></code></pre></div>
</div>
</div>
<div id="limitations" class="section level1">
<h1 class="hasAnchor">
<a href="#limitations" class="anchor"></a>Limitations</h1>
<p>This package is experimental and has not undergone rigorous testing to verify the correctness of the constructed queries. Use at your own risk.</p>
<p>The package has been written to cover a large number of immediate use cases. However, there are many additional features and parameters of Elasticsearch that could be exposed through this interface in the future.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Ryan Hafen.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
